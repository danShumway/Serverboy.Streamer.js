<!DOCTYPE html>
<html>

<head>
<script src="socket.io.js"></script>
<script>
	window.onload = function() {
		var canvas = document.getElementById('mainCanvas');
		var ctx = canvas.getContext('2d');
		var ctx_data = ctx.createImageData(160, 144);
		//Fill with white
		for(var i = 0; i < ctx_data.data.length; i++) {
			ctx_data.data[i] = 0xFF;
		}

		var frames = []; //
		var time = new Date(); var lastTime;
		var averageChunkTime = 1000;
		var samples = -1;
		var maxSamples = 2;

		var timeLeft = 0;
		var lastFrameDisplay;
		var timeRefresh = 0;

		console.log('about to connect');
		var socket = io.connect('http://localhost:3333');//'http://pigletplaysmainhost.herokuapp.com:80');
		socket.on('connect', function() {
			console.log('connected');

		});

		socket.on('video', function(data) {

			if(!lastTime){
				lastTime = Date.now();
			} else {
				var t = lastTime; 
				lastTime = Date.now();
				t = lastTime - t;
			}

			if(samples === 1) {
				averageChunkTime = t;
			} else if (samples > 1) {
				//Compute new average time.
				//use (samples+1)
				averageChunkTime = (averageChunkTime*samples + t)/(samples+1);
			} else {
				//You don't have an averageChunkTime, don't mess with the frame.
				samples++;
				return;
			}

			//Allow for changing over time.
			if(samples < maxSamples) {
				samples++;
			}

			frames = frames.concat(data.video);
			timeLeft = averageChunkTime;
			lastFrameDisplay = undefined;
			timeRefresh = averageChunkTime/frames.length;
			//console.log(window.dataStuff);
			console.log(frames[0][1] + ", " + frames[0][201]);
			//console.log(ctx_data.data[1]);

		});

		var draw = function() {

			if(frames.length > 0 && averageChunkTime !== undefined) {
				//pull off a frame and draw it.
				var frame = frames.shift();

				//
				var i; var place; var color;
				/*for (i = 0; i < frame.length; i++) {
					place = Math.floor(frame[i]);
					ctx_data.data[place] = (frame[i] - place)*1000;
				}*/
				/*for (i = 0; i < frame.length; i++) {
					place = Math.floor(frame[i]); 
					color = (frame[i] - place)*1000;

					//Swap place with where it should go on the destination.
					place = place + Math.floor(place/3)*1;
					ctx_data.data[place] = color;
				}*/
				for (i = 0; i < frame.length; i+=2) {
					place = Math.floor(frame[i]); 
					//color = (frame[i] - place)*100000000;
					color = frame[i+1];

					//Swap place with where it should go on the destination.
					place = place + Math.floor(place/1)*3;

					ctx_data.data[place] = (color >> 16) & 0xFF; //Red
					ctx_data.data[++place] = (color >> 8) & 0xFF; //Green
					ctx_data.data[++place] = color & 0xFF; // Blue
				}

				ctx.putImageData(ctx_data, 0, 0);

				//Set up timer.
				setTimeout(draw, timeRefresh);//timeLeft/frames.length);
				window.dataStuff = {
					length: frames.length,
					timeRefresh: timeRefresh
				}
				window.frames = frames;
			} else {
				setTimeout(draw, 0)
			}
		}


		draw();
	}

</script>
</head>

<body>
	<div>Let's see if this works</div>
	<canvas id="mainCanvas" width="160" height="144"></canvas>
</body>
</html>